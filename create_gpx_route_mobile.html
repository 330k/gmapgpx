<!DOCTYPE html><html lang=ja><!-- Copyright (c) 2014-2016 Kei Misawa This software is released under the MIT License. http://opensource.org/licenses/mit-license.php --><head><meta charset=utf-8 /><meta name=viewport content="width=device-width, initial-scale=1"/><title>Create GPX Route with Google Maps API v3</title><meta name=keywords content="Google,Maps,GPX,Route,Create,マップ,作成"/><meta name=description content="Create GPX file of routes with Google Maps API v3"/><meta name=author content=330k /><meta name=application-name content=GMapGPX /><meta name=mobile-web-app-capable content=yes /><meta name=apple-mobile-web-app-capable content=yes /><meta name=msapplication-TileColor content="#da532c"/><meta name=theme-color content="#ffffff"/><link rel=stylesheet href="http://code.jquery.com/mobile/1.4.2/jquery.mobile-1.4.2.min.css"/><link rel=apple-touch-icon sizes=57x57 href="apple-touch-icon-57x57.png"/><link rel=apple-touch-icon sizes=60x60 href="apple-touch-icon-60x60.png"/><link rel=apple-touch-icon sizes=72x72 href="apple-touch-icon-72x72.png"/><link rel=apple-touch-icon sizes=76x76 href="apple-touch-icon-76x76.png"/><link rel=apple-touch-icon sizes=114x114 href="apple-touch-icon-114x114.png"/><link rel=apple-touch-icon sizes=120x120 href="apple-touch-icon-120x120.png"/><link rel=icon type="image/png" href="favicon-32x32.png" sizes=32x32 /><link rel=icon type="image/png" href="favicon-96x96.png" sizes=96x96 /><link rel=icon type="image/png" href="favicon-16x16.png" sizes=16x16 /><link rel=manifest href="manifest.json"/><style type="text/css">html{height:100%}body{height:100%;margin:0;padding:0;user-select:none}#page_map{overflow:hidden}#map_canvas{position:absolute;left:0;top:0;width:100%;height:80%}#graph_canvas{position:absolute;left:0;top:80%;width:100%;height:20%;overflow:hidden;padding:1px}#gpx_text{display:none}</style></head><body><div data-role=header data-position=fixed data-theme=b class=ui-state-persist id=header><div data-role=navbar><ul><li><a href="#page_search" data-transition=none class=ui-btn-active>Search</a></li><li><a href="#page_map" data-transition=none>Map</a></li><li><a href="#page_gpx" data-transition=none>GPX</a></li><li><a href="#page_directions" data-transition=none>Directions</a></li><li><a href="#page_usage" data-transition=none>Usage</a></li></ul></div></div><div id=page_search data-role=page data-pagename=Search><div role=main class=ui-content><form>Origin:<div><input id=input_origin type=text value="東京駅"/></div><div id=waypoints data-role=collapsible><h3>Via:</h3><input id=input_waypoint_01 type=text value=""/><input id=input_waypoint_02 type=text value=""/><input id=input_waypoint_03 type=text value=""/><input id=input_waypoint_04 type=text value=""/><input id=input_waypoint_05 type=text value=""/><input id=input_waypoint_06 type=text value=""/><input id=input_waypoint_07 type=text value=""/><input id=input_waypoint_08 type=text value=""/></div>Destination:<div><input id=input_destination type=text value="横浜駅"/></div><div><label><input id=input_avoid_highways type=checkbox checked=checked value=""/>Avoid Highways</label></div><div><label><input id=input_avoid_tolls type=checkbox checked=checked value=""/>Avoid Tolls</label></div><div><label><input id=input_optimize_waypoints type=checkbox value=""/>Optimize waypoints</label></div><select id=select_travel_mode><option value=DRIVING selected=selected>Driving</option><option value=WALKING>Walking</option></select><input type=submit id=button_calc_route value="Calculate Route"/></form></div></div><div id=page_map data-role=page data-pagename=Map><div role=main class=ui-content><div id=map_canvas></div><div id=graph_canvas></div></div></div><div id=page_gpx data-role=page data-pagename=GPX><div role=main class=ui-content><div id=page_gpx_001>Download File Name:<input id=input_download_filename type=text value="download.gpx"/><a id=gpx_download_link>Download</a><select id=select_reduce_points><option value=100>Reduce into 100 points</option><option value=200>Reduce into 200 points</option><option value=400>Reduce into 400 points</option><option value=800 selected=selected>Reduce into 800 points</option><option value=2000>Reduce into 2000 points</option><option value=4000>Reduce into 4000 points</option><option value=8000>Reduce into 8000 points</option><option value=0>No reduction</option></select><div id=gpx_info></div></div><textarea id=gpx_text readonly=readonly wrap=soft></textarea></div></div><div id=page_directions data-role=page data-pagename=Directions><div role=main class=ui-content><div id=directions_panel></div></div></div><div id=page_usage data-role=page data-pagename=Usage><div role=main class=ui-content><h4>Basics</h4><ul><li>Input origin and destination</li><li>Click "Calculate Route" button</li><li>Download GPX file by "Download GPX"</li><li>Swipe left/right to change view</li><li>This page can be a "Web Application" if you add this page to your home</li></ul><h4>Elevation</h4><ul><li>Click "Add Elevation" button if you need elevation data</li><li>Elevation data is shown in right bottom area</li><li>Elevation request rate is 100 points / sec to avoid limitations of Google Maps Elevation API</li></ul><h4>Waypoints Simplify</h4><ul><li>The number of waypoints is up to 800 points by default</li><li>This limit can be changed by selecting option ("Full" means no reduction)</li><li>Ramer-Douglas-Peucker algorythm is used to reduce waypoints</li><li>Simplified line is shown by red one</li><li>Distance is calculated against simplified line</li></ul><a href="create_gpx_route.html" target=_blank>Desktop Edition</a></div></div><script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script><script src="http://ajax.googleapis.com/ajax/libs/jquerymobile/1.4.2/jquery.mobile.min.js"></script><script src="http://code.highcharts.com/highcharts.js"></script><script defer=defer>var map;var gpxdata={name:"",bounds:{minlat:0,minlon:0,maxlat:0,maxlon:0},desc:"",trksegs:[[]]};var directionsDisplay=null;navigator.standalone=navigator.standalone||(screen.height-document.documentElement.clientHeight<40);function initialize(){$("[data-role='header'], [data-role='footer']").toolbar();$(document).on("pageshow",'[data-role="page"]',function(){var b=$(this).jqmData("pagename");$('[data-role="navbar"] a.ui-btn-active').removeClass("ui-btn-active");$('[data-role="navbar"] a').each(function(){var c=$(this);if(c.text()===b){(function(d){setTimeout(function(){d.addClass("ui-btn-active")},0)})(c)}})});$("#page_map").on("pageshow",function(){$("#page_map").css("margin-top",$("#header").height());$("#page_map").height($(window).innerHeight()-$("#header").height()*2-2);if($("#graph_canvas").highcharts()){$("#graph_canvas").highcharts().setSize($("#graph_canvas").innerWidth(),$("#graph_canvas").innerHeight())}if(typeof map==="undefined"){$.mobile.loading("show",{text:"initializing google maps...",textVisible:true});map=new google.maps.Map(document.getElementById("map_canvas"),{zoom:6,mapTypeId:google.maps.MapTypeId.ROADMAP,center:new google.maps.LatLng(35.681382,139.766084)});directionsDisplay.setMap(map);google.maps.event.addListener(map,"tilesloaded",function(){$.mobile.loading("hide")})}google.maps.event.trigger(map,"resize");map.setZoom(map.getZoom())});$('body > div[id!="page_map"], #graph_canvas').on("swipeleft",function(){var b=$(document.body).pagecontainer("getActivePage")[0].nextElementSibling;if(b&&b.getAttribute("data-role")==="page"){$(document.body).pagecontainer("change","#"+b.id)}}).on("swiperight",function(){var b=$(document.body).pagecontainer("getActivePage")[0].previousElementSibling;if(b&&b.getAttribute("data-role")==="page"){$(document.body).pagecontainer("change","#"+b.id)}});$.mobile.defaultPageTransition="none";directionsDisplay=new google.maps.DirectionsRenderer({draggable:true});directionsDisplay.setPanel(document.getElementById("directions_panel"));google.maps.event.addListener(directionsDisplay,"directions_changed",function(){createGPXFromDirections(directionsDisplay.directions);updateSearchConditions(directionsDisplay.directions);$("#gpx_download_link").button("enable");$("#select_reduce_points").selectmenu("enable")});var a=new google.maps.Geocoder();$('#page_search input[type="text"]').blur(function(){var b=$(this);if(b.val()!==""){a.geocode({address:b.val()},function(d,c){if(c===google.maps.GeocoderStatus.OK){b.removeClass("ui-state-error")}else{b.addClass("ui-state-error")}})}else{b.removeClass("ui-state-error")}});$("#button_calc_route").attr("title","calculate route").click(function(b){calcRoute();b.preventDefault()});$("#gpx_download_link").button({disabled:true}).attr("title","download gpx file to your PC");$("#select_reduce_points").selectmenu({disabled:true}).change(function(){simplifyGPX($("#select_reduce_points").val());createGPXDownloadLink()});$("#graph_canvas").click(function(){$.mobile.loading("show",{text:"adding elevation...",textVisible:true});addElevationToGPX(function(b){if(b.state==="finished"){createGPXDownloadLink();$.mobile.loading("hide")}else{$.mobile.loading("show",{text:"adding elevation... "+b.value+"/"+b.max,textVisible:true})}})});$("#input_download_filename").change(function(){$("#gpx_download_link").attr("download",$(this).val())});createGPXDownloadLink()}function calcRoute(){var d=[];for(var a=1;a<=8;a++){if($("#input_waypoint_"+("0"+a).slice(-2)).val()){d.push({location:$("#input_waypoint_"+("0"+a).slice(-2)).val(),stopover:$("#input_optimize_waypoints").prop("checked")})}}var b={origin:$("#input_origin").val(),destination:$("#input_destination").val(),travelMode:google.maps.TravelMode[$("#select_travel_mode").val()],avoidHighways:$("#input_avoid_highways").prop("checked"),avoidTolls:$("#input_avoid_tolls").prop("checked"),waypoints:d,optimizeWaypoints:$("#input_optimize_waypoints").prop("checked")};$.mobile.loading("show",{text:"calculating route...",textVisible:true});var c=new google.maps.DirectionsService();c.route(b,function(f,e){if(e===google.maps.DirectionsStatus.OK){$("#page_map").one("pageshow",function(){directionsDisplay.setDirections(f)});$.mobile.loading("hide");$(document.body).pagecontainer("change","#page_map")}else{$.mobile.loading("hide");$('<div style="padding: 10px;">ルートが見つかりませんでした</div>').popup({history:false,theme:"a",overlayTheme:"a",positionTo:"window",afterclose:function(){$(this).popup("destroy")}}).popup("open")}})}function createGPXFromDirections(f){var n=f.routes[0];var a=n.bounds.toUrlValue().split(",");gpxdata.bounds.minlat=a[0];gpxdata.bounds.minlon=a[1];gpxdata.bounds.maxlat=a[2];gpxdata.bounds.maxlon=a[3];gpxdata.desc=n.copyrights;gpxdata.name=n.legs[0].start_address+" to "+n.legs[n.legs.length-1].end_address;gpxdata.trksegs=[[]];var c=540;var d=540;var b=gpxdata.trksegs[0];for(var h=0;h<n.legs.length;h++){for(var g=0;g<n.legs[h].steps.length;g++){for(var e=0;e<n.legs[h].steps[g].path.length;e++){var l=n.legs[h].steps[g].path[e].lat();var m=n.legs[h].steps[g].path[e].lng();if((l!==c)||(m!==d)){b.push({lat:l,lon:m,enabled:true,ele:null,priority:null});c=l;d=m}}}}simplifyGPX($("#select_reduce_points").val());createGPXDownloadLink()}function updateSearchConditions(b){var a=b.routes[0];$("#input_origin").val(a.legs[0].start_location.toUrlValue());$("#input_destination").val(a.legs[a.legs.length-1].end_location.toUrlValue());var f=1;var e=0;for(e=0;e<a.legs.length;e++){for(var d=0;d<a.legs[e].via_waypoints.length;d++){$("#input_waypoint_"+("0"+f).slice(-2)).val(a.legs[e].via_waypoints[d].toUrlValue());f++}}for(e=f;e<=8;e++){$("#input_waypoint_"+("0"+e).slice(-2)).val("")}}function createGPXDownloadLink(){try{var b=[];b.push('<?xml version="1.0" encoding="UTF-8"?>');b.push('<gpx version="1.0" creator="Create GPX Route with Google Maps API v3" xmlns="http://www.topografix.com/GPX/1/0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.topografix.com/GPX/1/0 http://www.topografix.com/GPX/1/0/gpx.xsd">');b.push("<desc>"+escapeXMLString(gpxdata.desc)+"</desc>");b.push("<url>http://www.330k.info/</url>");b.push('<bounds minlat="'+gpxdata.bounds.minlat+'" minlon="'+gpxdata.bounds.minlon+'" maxlat="'+gpxdata.bounds.maxlat+'" maxlon="'+gpxdata.bounds.maxlon+'" />');b.push("<trk>");b.push("<name>"+escapeXMLString(gpxdata.name)+"</name>");b.push("<trkseg>");var g=gpxdata.trksegs[0];for(var c=0;c<g.length;c++){if(g[c].enabled){b.push('<trkpt lat="'+g[c].lat.toFixed(5)+'" lon="'+g[c].lon.toFixed(5)+'">'+((g[c].ele!==null)?"<ele>"+g[c].ele.toFixed(2)+"</ele>":"")+"</trkpt>")}}b.push("</trkseg>");b.push("</trk>");b.push("</gpx>");var j=b.join("\n");$("#gpx_text").val(j);var f=document.getElementById("gpx_download_link");window.URL=window.URL||window.webkitURL;window.BlobBuilder=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder;if(window.URL&&window.URL.createObjectURL){var a=null;try{a=new Blob([j],{type:"application/xml"})}catch(d){var h=new BlobBuilder();h.append(j);a=h.getBlob("application/xml")}f.href=window.URL.createObjectURL(a)}else{f.href="data:application/octet-stream,"+encodeURIComponent(j);f.setAttribute("target","_blank")}f.setAttribute("download",$("#input_download_filename").val());setTimeout(function(){var e=calcDistance();$("#gpx_info").html("<div>"+g.length+" points to "+e.points+" points</div><div>Total Distance: "+(e.total_distance*0.001).toFixed(3)+" km</div><div>Total Elevation: "+e.total_elevation.toFixed(2)+" m</div>");$("#graph_canvas").highcharts(createGraphData())},0)}catch(d){alert(d)}}function escapeXMLString(b){var a=b;if(typeof a==="string"){a=a.replace("&","&amp;");a=a.replace(">","&gt;");a=a.replace("<","&lt;");a=a.replace('"',"&quot;");a=a.replace("'","&apos;")}else{a=""}return a}var calcDistance=(function(){var a=(function(){var d=6378137;var c=6356752.314245;var j=c*c/(d*d);var i=1-j;var h=Math.PI/180;var e=Math.sin;var g=Math.cos;var f=Math.sqrt;return function(q,s,o,r){var v=(q-o)*h;var x=(s-r)*h;var b=0.5*(q+o)*h;var t=e(b);var m=g(b);var p=1-t*t*i;var u=f(p);var l=d*j/(p*u);var k=d/u;return f(v*v*l*l+x*x*k*k*m*m)}})();return function(){var e=0;var g=0;var c=null;if(typeof gpxdata.trksegs[0][0]==="undefined"){return{points:0,total_distance:0,total_elevation:0}}var d=[];var f=gpxdata.trksegs[0];var b=0;for(b=0;b<f.length;b++){if(f[b].enabled){d.push(f[b])}}f[0].total_distance=0;for(b=1;b<d.length;b++){e+=a(d[b-1].lat,d[b-1].lon,d[b].lat,d[b].lon);if(d[b].ele!==null){if((c!==null)&&(d[b].ele>c)){g+=d[b].ele-c}c=d[b].ele}d[b].total_distance=e;d[b].total_elevation=g}return{points:d.length,total_distance:e,total_elevation:g}}})();var addElevationToGPX=(function(){var a=100;var b=500;var e={};var d=null;if(typeof localStorage!=="undefined"){try{e=JSON.parse(localStorage.getItem("elecache"));if(e===null){e={}}}catch(f){}}function c(g,h){if(d===null){d=new google.maps.ElevationService()}d.getElevationForLocations({locations:g},h)}return function(q){var o=[];var n=0;var m=[];var h=gpxdata.trksegs[0];var l=0;var k=0;for(l=0;l<h.length;l++){if((h[l].enabled)&&(h[l].ele===null)){var g=e[(new google.maps.LatLng(h[l].lat,h[l].lon)).toUrlValue()];if(g){h[l].ele=g-0}else{m.push(h[l])}}}var p=m.length;if(p===0){q({state:"finished",content:""});return}q({state:"processing",content:"requesting... ",max:p,value:0});for(k=0;k<p;k+=a){o=[];for(l=k;(l<k+a)&&(l<p);l++){o.push(new google.maps.LatLng(m[l].lat,m[l].lon))}(function(r,i){setTimeout(function(){c(i,function(t,j){if(j===google.maps.ElevationStatus.OK){for(var s=0;s<t.length;s++){m[s+r].ele=t[s].elevation.toFixed(2)-0;e[t[s].location.toUrlValue()]=t[s].elevation.toFixed(2)}}else{console.log(j)}n+=i.length;try{localStorage.setItem("elecache",JSON.stringify(e))}catch(u){}if(n>=p){q({state:"finished",content:""})}else{q({state:"processing",content:"processing... "+n+"/"+p,max:p,value:n})}})},r*b/a)})(k,o)}q({state:"processing",content:"processing... "+0+"/"+p,max:p,value:0})}})();var simplifyGPX=(function(){var f=Math.PI/180;var d=Math.PI/4;function b(){if(typeof gpxdata.trksegs[0][0]==="undefined"){return}var n=[];var m=gpxdata.trksegs[0];for(var j=0;j<m.length;j++){n[j]=[m[j].lon*f,Math.log(Math.abs(Math.tan(d+0.5*m[j].lat*f)))]}var g=new a();var l=e(n,0,n.length-1);g.enqueue(l.dist,l);m[0].priority=1;m[n.length-1].priority=2;var k=2;while(g.size()){var h=g.dequeue();k++;if(h.pos>=0){m[h.pos].priority=k}if(h.start+2<=h.pos){l=e(n,h.start,h.pos);g.enqueue(l.dist,l)}if(h.pos+2<=h.end){l=e(n,h.pos,h.end);g.enqueue(l.dist,l)}}return}function e(r,h,k){var g=r[h][0];var s=r[h][1];var q=r[k][0];var o=r[k][1];var n=0;var j=-Number.MAX_VALUE;var p=-1;for(var l=h+1;l<k;l++){n=c(g,s,q,o,r[l][0],r[l][1]);if(j<n){j=n;p=l}}return{start:h,end:k,pos:p,dist:j}}function c(g,o,i,h,m,k){var n=(g*g+o*o+i*m-g*(i+m)+h*k-o*(h+k))/(g*g+o*o-2*g*i+i*i-2*o*h+h*h);if((0<=n)&&(n<=1)){var l=g-(g-i)*n;var j=o-(o-h)*n;return((l-m)*(l-m)+(j-k)*(j-k))}else{if(n>1){return((i-m)*(i-m)+(h-k)*(h-k))}else{return((g-m)*(g-m)+(o-k)*(o-k))}}}function a(){this.name="Pairing Heap";this._size=0;this._root=null;this._merge=function(k,h){if(k===null){return h}if(h===null){return k}if(k.p<h.p){var g=k;k=h;h=g}h.next=k.head;k.head=h;return k};this._mergeList=function(k){var l=null;while(k!==null){var h=k;var g=null;k=k.next;h.next=null;if(k!==null){g=k;k=k.next;g.next=null}h=this._merge(h,g);h.next=l;l=h}while(l!==null){var i=l;l=l.next;k=this._merge(i,k)}return k};this.enqueue=function(g,h){this._root=this._merge(this._root,{p:g,v:h,next:null,head:null});this._size++};this.dequeue=function(){var g=this._root.v;this._root=this._mergeList(this._root.head);this._size--;return g};this.size=function(){return this._size};return this}return function(g){var k=g||400;var j=gpxdata.trksegs[0];var h=0;for(h=0;h<j.length;h++){if(j[h].priority===null){b();break}}if(k<=0){for(h=0;h<j.length;h++){j[h].enabled=true}}else{for(h=0;h<j.length;h++){if(j[h].priority<=k){j[h].enabled=true}else{j[h].enabled=false}}}}})();var createGraphData=(function(){var a=null;return function(){var f=gpxdata.trksegs[0];var c={};var b=100;if(typeof f[0]!=="undefined"){b=f[f.length-1].total_distance*0.001}var e={chart:{type:"area",animation:false,zoomType:"none",events:{click:function(){$.mobile.loading("show",{text:"adding elevation...",textVisible:true});addElevationToGPX(function(h){if(h.state==="finished"){createGPXDownloadLink();$.mobile.loading("hide")}else{$.mobile.loading("show",{text:"adding elevation... "+h.value+"/"+h.max,textVisible:true})}})}}},legend:{enabled:false},title:null,xAxis:{title:{text:"distance (km)"},gridLineWidth:1,lineColor:"#000",tickColor:"#000",min:0,max:b},yAxis:{title:{text:"evelation (m)"},gridLineWidth:1,lineColor:"#000",tickColor:"#000"},plotLines:[{value:0,width:4,color:"#808080"}],plotOptions:{series:{animation:false,marker:{enabled:false},allowPointSelect:true,point:{events:{mouseOver:function(){map.setCenter(c[this.x]);if(a.getMap()===null){a.setMap(map)}a.setPosition(c[this.x])}}},events:{mouseOut:function(){a.setMap(null)}}}},series:[{name:"evelation",data:[]}]};if(a===null){a=new google.maps.Marker({position:null,map:null})}for(var d=0;d<f.length;d++){if(f[d].enabled&&f[d].total_distance&&f[d].ele){var g=(f[d].total_distance*0.001).toFixed(3)-0;e.series[0].data.push([g,f[d].ele.toFixed(2)-0]);c[g]=new google.maps.LatLng(f[d].lat,f[d].lon)}}return e}})();(function(d,e,j,h,f,c,b){d.GoogleAnalyticsObject=f;d[f]=d[f]||function(){(d[f].q=d[f].q||[]).push(arguments)},d[f].l=1*new Date();c=e.createElement(j),b=e.getElementsByTagName(j)[0];c.async=1;c.src=h;b.parentNode.insertBefore(c,b)})(window,document,"script","//www.google-analytics.com/analytics.js","ga");ga("create","UA-5655726-6","auto");ga("send","pageview");</script><script src="http://maps.google.com/maps/api/js?callback=initialize"></script></body></html>