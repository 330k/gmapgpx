<!DOCTYPE html><html lang=ja><!-- Copyright (c) 2014 Kei Misawa This software is released under the MIT License. http://opensource.org/licenses/mit-license.php --><head><meta charset=utf-8 /><title>Create GPX Route with Google Maps API v3</title><link rel=stylesheet href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/themes/redmond/jquery-ui.css"/><style type="text/css">html{height:100%}body{height:100%;margin:0;padding:0}#center_panel{position:absolute;right:0;top:0;width:70%;height:100%}#map_canvas{position:absolute;right:0;top:0;width:100%;height:80%}#graph_panel{position:absolute;right:0;top:80%;width:100%;height:20%;overflow:hidden}#graph_canvas{margin:1px}#side_panel{position:absolute;left:0;top:0;width:30%;min-width:200px;height:100%;overflow:hidden}#accordion{font-size:80%}#tab_search input[type="text"]{width:100%}#tab_search input[type="submit"]{width:100%}#tab_search select{width:100%}#gpx_download_link{display:block;width:100%}#tab_gpx select{width:100%}#tab_gpx input[type="text"]{width:100%}#button_add_elevation{width:100%}#gpx_text{width:100%;height:80%;font-size:10px;overflow:auto}button.ui-dialog-titlebar-close{display:none}</style></head><body><div id=center_panel><div id=map_canvas></div><div id=graph_panel><div id=graph_canvas></div></div></div><div id=side_panel><div id=accordion><h3>Search</h3><div id=tab_search><form>Origin:<div><input id=input_origin type=text value="東京駅"/></div><div id=waypoints>Via:<input id=input_waypoint_01 type=text value=""/><input id=input_waypoint_02 type=text value=""/><input id=input_waypoint_03 type=text value=""/><input id=input_waypoint_04 type=text value=""/><input id=input_waypoint_05 type=text value=""/><input id=input_waypoint_06 type=text value=""/><input id=input_waypoint_07 type=text value=""/><input id=input_waypoint_08 type=text value=""/></div>Destination:<div><input id=input_destination type=text value="横浜駅"/></div><div><label><input id=input_avoid_highways type=checkbox checked=checked value=""/>Avoid Highways</label></div><div><label><input id=input_avoid_tolls type=checkbox checked=checked value=""/>Avoid Tolls</label></div><div><label><input id=input_optimize_waypoints type=checkbox value=""/>Optimize waypoints</label></div><select id=select_travel_mode><option value=DRIVING selected=selected>Driving</option><option value=WALKING>Walking</option></select><input type=submit id=button_calc_route value="Calculate Route"/></form></div><h3>GPX</h3><div id=tab_gpx><div id=tab_gpx_001><span>GPX File Name:</span><input id=input_download_filename type=text value="download.gpx"/><a id=gpx_download_link>Download</a><select id=select_reduce_points><option value=100>100 points</option><option value=200>200 points</option><option value=400>400 points</option><option value=800>800 points</option><option value=2000>2000 points</option><option value=4000>4000 points</option><option value=8000>8000 points</option><option value=0 selected=selected>Full</option></select><button id=button_add_elevation>Add Elevation</button><div id=gpx_info></div></div><textarea id=gpx_text readonly=readonly wrap=off></textarea></div><h3>Directions</h3><div id=tab_directions><div id=directions_panel></div></div></div></div><!--<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script><script src="http://maps.google.com/maps/api/js?sensor=true"></script><script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/jquery-ui.min.js"></script><script src="http://code.highcharts.com/highcharts.js"></script>--><script defer=defer>var map;var gpxdata={name:"",bounds:{minlat:0,minlon:0,maxlat:0,maxlon:0},desc:"",trksegs:[[]]};function loadScript(b){var a=document.createElement("script");a.type="text/javascript";a.src=b[0];if(b.length>1){a.onload=function(){loadScript(b.slice(1))}}document.body.appendChild(a)}loadScript(["http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js","http://ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/jquery-ui.min.js","http://code.highcharts.com/highcharts.js","http://maps.google.com/maps/api/js?sensor=true&callback=initialize"]);function initialize(){map=new google.maps.Map(document.getElementById("map_canvas"),{zoom:6,mapTypeId:google.maps.MapTypeId.ROADMAP,center:new google.maps.LatLng(35.681382,139.766084)});var b=new google.maps.DirectionsRenderer({draggable:true});b.setMap(map);b.setPanel(document.getElementById("directions_panel"));google.maps.event.addListener(b,"directions_changed",function(){createGPXFromDirections(b.directions);updateSearchConditions(b.directions);$("#accordion").accordion("option","active",1);$("#gpx_download_link").button("option","disabled",false);$("#select_reduce_points").removeAttr("disabled");$("#button_add_elevation").button("option","disabled",false)});$('<ul id="rmenu"><li><a id="rmenu_set_origin">Set this point as Origin</a></li><li><a id="rmenu_set_destination">Set this point as Destination</a></li><li><a id="rmenu_clear_waypoints">Clear all Waypoints</a></li></div>').appendTo($("body")).menu().css("position","absolute").hide();google.maps.event.addListener(map,"rightclick",function(c){(function(e,d){$("#rmenu_set_origin").off("click").click(function(f){f.preventDefault();$("#input_origin").val(e+","+d);$("#rmenu").hide();$("#accordion").accordion("option","active",0);if(typeof gpxdata.trksegs[0][0]!=="undefined"){calcRoute(b)}});$("#rmenu_set_destination").off("click").click(function(f){f.preventDefault();$("#input_destination").val(e+","+d);$("#rmenu").hide();$("#accordion").accordion("option","active",0);if(typeof gpxdata.trksegs[0][0]!=="undefined"){calcRoute(b)}});$("#rmenu_clear_waypoints").off("click").click(function(g){g.preventDefault();for(var f=1;f<=8;f++){$("#input_waypoint_"+("0"+f).slice(-2)).val("")}if(typeof gpxdata.trksegs[0][0]!=="undefined"){calcRoute(b)}})})(c.latLng.lat().toFixed(5),c.latLng.lng().toFixed(5));$("#rmenu").css({left:c.pixel.x+$("#map_canvas").position().left+$("#center_panel").position().left,top:c.pixel.y+$("#map_canvas").position().top+$("#center_panel").position().top}).on("mouseleave",function(){setTimeout(function(){$("#rmenu").hide()},200)}).show()});google.maps.event.addListener(map,"click",function(c){$("#rmenu").hide()});$('<div id="dialog"></div>').dialog({modal:true,closeOnEscape:false,autoOpen:false,draggable:false,resizable:false});$("#accordion").accordion({heightStyle:"fill",animate:false,activate:function(c,d){$("#gpx_text").height($("#tab_gpx").innerHeight()-$("#tab_gpx_001").outerHeight()-$("#tab_gpx_001").position().top)}});$("#side_panel").resizable({handles:"e",resize:function(c,d){$("#center_panel").width($("body").innerWidth()-$("#side_panel").width());$("#graph_panel").resize()}}).resize(function(){if(typeof localStorage!=="undefined"){localStorage.setItem("side_panel_width",$("#side_panel").width())}});$("#graph_panel").resizable({handles:"n",resize:function(c,d){$("#map_canvas").height($("#center_panel").innerHeight()-$("#graph_panel").height())}}).resize(function(){$("#graph_canvas").highcharts().setSize($("#graph_panel").innerWidth(),$("#graph_panel").innerHeight());if(typeof localStorage!=="undefined"){localStorage.setItem("graph_panel_height",$("#graph_panel").height())}});var a=new google.maps.Geocoder();$('#tab_search input[type="text"]').blur(function(){var c=$(this);if(c.val()!==""){a.geocode({address:c.val()},function(e,d){if(d===google.maps.GeocoderStatus.OK){c.removeClass("ui-state-error")}else{c.addClass("ui-state-error")}})}else{c.removeClass("ui-state-error")}});$("#button_calc_route").button().attr("title","calculate route").click(function(c){calcRoute(b);c.preventDefault()});$("#gpx_download_link").button({disabled:true}).attr("title","download gpx file to your PC");$("#select_reduce_points").attr("disabled","disabled").change(function(){simplifyGPX($("#select_reduce_points").val());createGPXDownloadLink()});$("#button_add_elevation").button({disabled:true}).click(function(){$("#dialog").html('<div id="dialog_message"></div><div id="dialog_progressbar"></div>').dialog({title:"Elevation Addition"}).dialog("open");$("#dialog_progressbar").progressbar({value:0});addElevationToGPX(function(c){if(c.state==="finished"){createGPXDownloadLink();$("#dialog").dialog("close")}else{$("#dialog_message").html(c.content);$("#dialog_progressbar").progressbar("option",{value:c.value,max:c.max})}})}).attr("title","add elevation to each trkpt element from Google Maps Elevation API");$("#input_download_filename").change(function(){$("#gpx_download_link").attr("download",$(this).val())});createGPXDownloadLink()}function calcRoute(b){var e=[];for(var a=1;a<=8;a++){if(document.getElementById("input_waypoint_"+("0"+a).slice(-2)).value){e.push({location:document.getElementById("input_waypoint_"+("0"+a).slice(-2)).value,stopover:document.getElementById("input_optimize_waypoints").checked})}}var c={origin:document.getElementById("input_origin").value,destination:document.getElementById("input_destination").value,travelMode:google.maps.TravelMode[document.getElementById("select_travel_mode").value],avoidHighways:document.getElementById("input_avoid_highways").checked,avoidTolls:document.getElementById("input_avoid_tolls").checked,waypoints:e,optimizeWaypoints:document.getElementById("input_optimize_waypoints").checked};$("#dialog").dialog({title:"Route Calculation"}).html("calculating...").dialog("open");var d=new google.maps.DirectionsService();d.route(c,function(g,f){if(f===google.maps.DirectionsStatus.OK){b.setDirections(g);$("#dialog").dialog("close")}else{$("#dialog").html('<span class="ui-icon ui-icon-alert"></span>ルートが見つかりませんでした').dialog("option",{buttons:[{text:"OK",click:function(i,h){$(this).dialog("close");$(this).dialog("option",{buttons:[]})}}]})}})}function createGPXFromDirections(f){var n=f.routes[0];var a=n.bounds.toUrlValue().split(",");gpxdata.bounds.minlat=a[0];gpxdata.bounds.minlon=a[1];gpxdata.bounds.maxlat=a[2];gpxdata.bounds.maxlon=a[3];gpxdata.desc=n.copyrights;gpxdata.name=n.legs[0].start_address+" to "+n.legs[n.legs.length-1].end_address;gpxdata.trksegs=[[]];var c=540;var d=540;var b=gpxdata.trksegs[0];for(var h=0;h<n.legs.length;h++){for(var g=0;g<n.legs[h].steps.length;g++){for(var e=0;e<n.legs[h].steps[g].path.length;e++){var l=n.legs[h].steps[g].path[e].lat();var m=n.legs[h].steps[g].path[e].lng();if((l!==c)||(m!==d)){b.push({lat:l,lon:m,enabled:true,ele:null,priority:null});c=l;d=m}}}}simplifyGPX($("#select_reduce_points").val());createGPXDownloadLink()}function updateSearchConditions(b){var a=b.routes[0];$("#input_origin").val(a.legs[0].start_address);$("#input_destination").val(a.legs[a.legs.length-1].end_address);var f=1;var e=0;for(e=0;e<a.legs.length;e++){for(var d=0;d<a.legs[e].via_waypoints.length;d++){$("#input_waypoint_"+("0"+f).slice(-2)).val(a.legs[e].via_waypoints[d].toUrlValue());f++}}for(e=f;e<=8;e++){$("#input_waypoint_"+("0"+e).slice(-2)).val("")}}function createGPXDownloadLink(){try{var b=[];b.push('<?xml version="1.0" encoding="UTF-8"?>');b.push('<gpx version="1.0" creator="Create GPX Route with Google Maps API v3" xmlns="http://www.topografix.com/GPX/1/0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.topografix.com/GPX/1/0 http://www.topografix.com/GPX/1/0/gpx.xsd">');b.push("<desc>"+escapeXMLString(gpxdata.desc)+"</desc>");b.push("<url>http://www.330k.info/</url>");b.push('<bounds minlat="'+gpxdata.bounds.minlat+'" minlon="'+gpxdata.bounds.minlon+'" maxlat="'+gpxdata.bounds.maxlat+'" maxlon="'+gpxdata.bounds.maxlon+'" />');b.push("<trk>");b.push("<name>"+escapeXMLString(gpxdata.name)+"</name>");b.push("<trkseg>");var g=gpxdata.trksegs[0];for(var c=0;c<g.length;c++){if(g[c].enabled){b.push('<trkpt lat="'+g[c].lat.toFixed(5)+'" lon="'+g[c].lon.toFixed(5)+'">'+((g[c].ele!==null)?"<ele>"+g[c].ele.toFixed(2)+"</ele>":"")+"</trkpt>")}}b.push("</trkseg>");b.push("</trk>");b.push("</gpx>");var j=b.join("\n");document.getElementById("gpx_text").value=j;var f=document.getElementById("gpx_download_link");window.URL=window.URL||window.webkitURL;window.BlobBuilder=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder;if(window.URL&&window.URL.createObjectURL){var a=null;try{a=new Blob([j],{type:"application/xml"})}catch(d){var h=new BlobBuilder();h.append(j);a=h.getBlob("application/xml")}f.href=window.URL.createObjectURL(a)}else{f.href="data:application/octet-stream,"+encodeURIComponent(j);f.setAttribute("target","_blank")}f.setAttribute("download",document.getElementById("input_download_filename").value);setTimeout(function(){var e=calcDistance();$("#gpx_info").html("<div>"+e.points+" points</div><div>Total Distance: "+(e.total_distance*0.001).toFixed(3)+" km</div><div>Total Elevation: "+e.total_elevation.toFixed(2)+" m</div>")},0);setTimeout(function(){$("#graph_canvas").highcharts(createGraphData());$("#graph_canvas").highcharts().setSize($("#graph_panel").innerWidth(),$("#graph_panel").innerHeight());drawSimplifiedLine()},0)}catch(d){alert(d)}}function escapeXMLString(b){var a=b;if(typeof a==="string"){a=a.replace("&","&amp;");a=a.replace(">","&gt;");a=a.replace("<","&lt;");a=a.replace('"',"&quot;");a=a.replace("'","&apos;")}else{a=""}return a}var calcDistance=(function(){var a=(function(){var d=6378137;var c=6356752.314245;var j=c*c/(d*d);var i=1-j;var h=Math.PI/180;var e=Math.sin;var g=Math.cos;var f=Math.sqrt;return function(q,s,o,r){var v=(q-o)*h;var x=(s-r)*h;var b=0.5*(q+o)*h;var t=e(b);var m=g(b);var p=1-t*t*i;var u=f(p);var l=d*j/(p*u);var k=d/u;return f(v*v*l*l+x*x*k*k*m*m)}})();return function(){var e=0;var g=0;var c=null;if(typeof gpxdata.trksegs[0][0]==="undefined"){return{points:0,total_distance:0,total_elevation:0}}var d=[];var f=gpxdata.trksegs[0];var b=0;for(b=0;b<f.length;b++){if(f[b].enabled){d.push(f[b])}}f[0].total_distance=0;for(b=1;b<d.length;b++){e+=a(d[b-1].lat,d[b-1].lon,d[b].lat,d[b].lon);if(d[b].ele!==null){if((c!==null)&&(d[b].ele>c)){g+=d[b].ele-c}c=d[b].ele}d[b].total_distance=e;d[b].total_elevation=g}return{points:d.length,total_distance:e,total_elevation:g}}})();var addElevationToGPX=(function(){var a=100;var b=1000;var e={};var d=null;if(typeof localStorage!=="undefined"){try{e=JSON.parse(localStorage.getItem("elecache"));if(e===null){e={}}}catch(f){}window.unload=(function(){try{localStorage.setItem("elecache",JSON.stringify(e))}catch(g){}})}function c(g,h){if(d===null){d=new google.maps.ElevationService()}d.getElevationForLocations({locations:g},function(j,i){if(i===google.maps.ElevationStatus.OK){h(j)}else{if(i===google.maps.ElevationStatus.INVALID_REQUEST){console.log("リクエストに問題アリ！requestで渡している内容を確認せよ！！")}else{if(i===google.maps.ElevationStatus.OVER_QUERY_LIMIT){console.log("短時間にクエリを送りすぎ！落ち着いて！！")}else{if(i===google.maps.ElevationStatus.REQUEST_DENIED){console.log("このページでは ElevationResult の利用が許可されていない！・・・なぜ！？")}else{if(i===google.maps.ElevationStatus.UNKNOWN_ERROR){console.log("原因不明のなんらかのトラブルが発生した模様。")}else{console.log("えぇ～っと・・、バージョンアップ？")}}}}}})}return function(q){var o=[];var n=0;var m=[];var h=gpxdata.trksegs[0];var l=0;for(l=0;l<h.length;l++){if((h[l].enabled)&&(h[l].ele===null)){var g=e[(new google.maps.LatLng(h[l].lat,h[l].lon)).toUrlValue()];if(g){h[l].ele=g-0}else{m.push(h[l])}}}var p=m.length;if(p===0){q({state:"finished",content:""});return}q({state:"processing",content:"requesting... ",max:p,value:0});for(var k=0;k<p;k+=a){o=[];for(l=k;(l<k+a)&&(l<p);l++){o.push(new google.maps.LatLng(m[l].lat,m[l].lon))}(function(r,i){setTimeout(function(){c(i,function(s){for(var j=0;j<s.length;j++){m[j+r].ele=s[j].elevation.toFixed(2)-0;e[s[j].location.toUrlValue()]=s[j].elevation.toFixed(2)}n+=i.length;if(n>=p){q({state:"finished",content:""})}else{q({state:"processing",content:"processing... "+n+"/"+p,max:p,value:n})}})},r*b/a)})(k,o)}q({state:"processing",content:"processing... "+0+"/"+p,max:p,value:0})}})();var simplifyGPX=(function(){var f=Math.PI/180;var d=Math.PI/4;function b(){if(typeof gpxdata.trksegs[0][0]==="undefined"){return}var n=[];var m=gpxdata.trksegs[0];for(var j=0;j<m.length;j++){n[j]=[m[j].lon*f,Math.log(Math.abs(Math.tan(d+0.5*m[j].lat*f)))]}var g=new a();var l=e(n,0,n.length-1);g.enqueue(l.dist,l);m[0].priority=1;m[n.length-1].priority=2;var k=2;while(g.size()){var h=g.dequeue();k++;if(h.pos>=0){m[h.pos].priority=k}if(h.start+2<=h.pos){l=e(n,h.start,h.pos);g.enqueue(l.dist,l)}if(h.pos+2<=h.end){l=e(n,h.pos,h.end);g.enqueue(l.dist,l)}}return}function e(r,h,k){var g=r[h][0];var s=r[h][1];var q=r[k][0];var o=r[k][1];var n=0;var j=-Number.MAX_VALUE;var p=-1;for(var l=h+1;l<k;l++){n=c(g,s,q,o,r[l][0],r[l][1]);if(j<n){j=n;p=l}}return{start:h,end:k,pos:p,dist:j}}function c(g,o,i,h,m,k){var n=(g*g+o*o+i*m-g*(i+m)+h*k-o*(h+k))/(g*g+o*o-2*g*i+i*i-2*o*h+h*h);if((0<=n)&&(n<=1)){var l=g-(g-i)*n;var j=o-(o-h)*n;return((l-m)*(l-m)+(j-k)*(j-k))}else{if(n>1){return((i-m)*(i-m)+(h-k)*(h-k))}else{return((g-m)*(g-m)+(o-k)*(o-k))}}}function a(){this.name="Pairing Heap";this._size=0;this._root=null;this._merge=function(k,h){if(k===null){return h}if(h===null){return k}if(k.p<h.p){var g=k;k=h;h=g}h.next=k.head;k.head=h;return k};this._mergeList=function(k){var l=null;while(k!==null){var h=k;var g=null;k=k.next;h.next=null;if(k!==null){g=k;k=k.next;g.next=null}h=this._merge(h,g);h.next=l;l=h}while(l!==null){var i=l;l=l.next;k=this._merge(i,k)}return k};this.enqueue=function(g,h){this._root=this._merge(this._root,{p:g,v:h,next:null,head:null});this._size++};this.dequeue=function(){var g=this._root.v;this._root=this._mergeList(this._root.head);this._size--;return g};this.size=function(){return this._size};return this}return function(g){var k=g||400;var j=gpxdata.trksegs[0];var h=0;for(h=0;h<j.length;h++){if(j[h].priority===null){b();break}}if(k<=0){for(h=0;h<j.length;h++){j[h].enabled=true}}else{for(h=0;h<j.length;h++){if(j[h].priority<=k){j[h].enabled=true}else{j[h].enabled=false}}}}})();var createGraphData=(function(){var a=null;return function(){var e=gpxdata.trksegs[0];var b={};var d={chart:{type:"area",animation:false,zoomType:"x"},legend:{enabled:false},title:null,xAxis:{title:{text:"distance (km)"},gridLineWidth:1,lineColor:"#000",tickColor:"#000"},yAxis:{title:{text:"evelation (m)"},gridLineWidth:1,lineColor:"#000",tickColor:"#000"},plotLines:[{value:0,width:4,color:"#808080"}],plotOptions:{series:{animation:false,marker:{enabled:false},allowPointSelect:true,point:{events:{mouseOver:function(){map.setCenter(b[this.x]);if(a.getMap()===null){a.setMap(map)}a.setPosition(b[this.x])}}},events:{mouseOut:function(){a.setMap(null)}}}},series:[{name:"evelation",data:[]}]};if(a===null){a=new google.maps.Marker({position:null,map:null})}for(var c=0;c<e.length;c++){if(e[c].enabled&&e[c].total_distance&&e[c].ele){var f=(e[c].total_distance*0.001).toFixed(3)-0;d.series[0].data.push([f,e[c].ele.toFixed(2)-0]);b[f]=new google.maps.LatLng(e[c].lat,e[c].lon)}}return d}})();var drawSimplifiedLine=(function(){var a=null;return function(){var c=[];var e=gpxdata.trksegs[0];var d=false;for(var b=0;b<e.length;b++){if(e[b].enabled){c.push(new google.maps.LatLng(e[b].lat,e[b].lon))}else{d=true}}if(d){if(a){a.setPath(c)}else{a=new google.maps.Polyline({path:c,strokeColor:"#FF0000",strokeOpacity:1,strokeWeight:2,zIndex:100,clickable:false,map:map})}}else{if(a){a.setMap(null)}a=null}}})();</script></body></html>